<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥æœ¬ç†Šå‡ºæ²’ç›£æ¸¬åœ°åœ– (LIVE)</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <style>
        body { margin: 0; padding: 0; font-family: "Helvetica Neue", Arial, sans-serif; background-color: #1a1a1a; color: #e0e0e0; display: flex; height: 100vh; overflow: hidden; }
        
        /* å·¦å´åœ°åœ– */
        #map { flex: 2; height: 100%; z-index: 1; }

        /* å³å´æ–°èåˆ—è¡¨ */
        #sidebar { flex: 1; min-width: 320px; max-width: 450px; background-color: #252525; display: flex; flex-direction: column; border-left: 1px solid #333; box-shadow: -2px 0 10px rgba(0,0,0,0.5); z-index: 2; }
        
        /* æ¨™é¡Œå€ */
        .header { padding: 20px; background-color: #2d2d2d; border-bottom: 1px solid #333; text-align: center; }
        .header h2 { margin: 0; font-size: 1.5rem; color: #fff; display: flex; align-items: center; justify-content: center; gap: 10px; }
        
        /* é€²åº¦æ¢ */
        #status-bar { padding: 10px 20px; font-size: 0.9rem; color: #aaa; background: #1f1f1f; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        .clear-cache-btn { cursor: pointer; color: #888; text-decoration: underline; font-size: 0.8rem; }
        .clear-cache-btn:hover { color: #fff; }

        /* æ–°èåˆ—è¡¨æ²å‹•å€ */
        #news-list { flex: 1; overflow-y: auto; padding: 10px; }
        
        /* æ–°èå¡ç‰‡ */
        .news-card { background-color: #333; margin-bottom: 15px; border-radius: 8px; padding: 15px; transition: transform 0.2s, background-color 0.2s; border-left: 5px solid #555; cursor: pointer; }
        .news-card:hover { transform: translateY(-2px); background-color: #3a3a3a; }
        .news-card.loc-success { border-left-color: #28a745; } /* ç¶ è‰²ï¼šæˆåŠŸ */
        .news-card.loc-approx { border-left-color: #ffc107; } /* é»ƒè‰²ï¼šæ¦‚ç•¥ä½ç½® */
        .news-card.loc-fail { border-left-color: #dc3545; }    /* ç´…è‰²ï¼šå¤±æ•— */
        
        .news-title { font-size: 1.1rem; font-weight: bold; margin-bottom: 8px; color: #fff; line-height: 1.4; }
        .news-meta { font-size: 0.85rem; color: #aaa; margin-bottom: 10px; }
        .news-link { display: inline-block; color: #4da3ff; text-decoration: none; font-size: 0.9rem; margin-top: 5px; }
        .news-link:hover { text-decoration: underline; }

        /* ç‹€æ…‹æ¨™ç±¤ */
        .status-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-left: 8px; vertical-align: middle; }
        .badge-success { background: rgba(40, 167, 69, 0.2); color: #28a745; }
        .badge-fail { background: rgba(220, 53, 69, 0.2); color: #dc3545; }
        .badge-approx { background: rgba(255, 193, 7, 0.2); color: #ffc107; }

        /* éŸ¿æ‡‰å¼ */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            #map { flex: 1; height: 50vh; }
            #sidebar { flex: 1; height: 50vh; min-width: 100%; max-width: 100%; }
        }

        /* è®€å–å‹•ç•« */
        .loading-spinner { display: inline-block; width: 12px; height: 12px; border: 2px solid #aaa; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite; margin-right: 5px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="map"></div>

    <div id="sidebar">
        <div class="header">
            <h2>ğŸ» æ™ºèƒ½ç†Šå‡ºæ²’ç›£æ¸¬</h2>
        </div>
        <div id="status-bar">
            <span id="progress-text"><div class="loading-spinner"></div>è®€å–æ•¸æ“šä¸­...</span>
            <span class="clear-cache-btn" onclick="clearCache()">æ¸…é™¤ç·©å­˜</span>
        </div>
        <div id="news-list">
            <!-- æ–°èå¡ç‰‡å°‡æ’å…¥æ­¤è™• -->
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <script>
        // --- 1. åˆå§‹åŒ–åœ°åœ– ---
        const map = L.map('map').setView([38.0, 137.0], 5); // é è¨­æ—¥æœ¬ä¸­å¿ƒ
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        const markers = L.markerClusterGroup();
        map.addLayer(markers);

        // --- 2. æ•¸æ“šèˆ‡ç·©å­˜è¨­å®š ---
        const CACHE_KEY = 'bear_map_locations_v2'; // å‡ç´šç‰ˆæœ¬è™Ÿä»¥é‡ç½®èˆŠç·©å­˜
        let locationCache = JSON.parse(localStorage.getItem(CACHE_KEY)) || {};
        let fetchQueue = [];
        let isProcessing = false;

        // --- 3. æ—¥æœ¬è¡Œæ”¿å€åŠƒæ¸…å–® (ç”¨æ–¼è¼”åŠ©è­˜åˆ¥) ---
        const PREFECTURES = [
            "åŒ—æµ·é“", "é’æ£®çœŒ", "å²©æ‰‹çœŒ", "å®®åŸçœŒ", "ç§‹ç”°çœŒ", "å±±å½¢çœŒ", "ç¦å³¶çœŒ",
            "èŒ¨åŸçœŒ", "æ ƒæœ¨çœŒ", "ç¾¤é¦¬çœŒ", "åŸ¼ç‰çœŒ", "åƒè‘‰çœŒ", "æ±äº¬éƒ½", "ç¥å¥ˆå·çœŒ",
            "æ–°æ½ŸçœŒ", "å¯Œå±±çœŒ", "çŸ³å·çœŒ", "ç¦äº•çœŒ", "å±±æ¢¨çœŒ", "é•·é‡çœŒ", "å²é˜œçœŒ",
            "é™å²¡çœŒ", "æ„›çŸ¥çœŒ", "ä¸‰é‡çœŒ", "æ»‹è³€çœŒ", "äº¬éƒ½åºœ", "å¤§é˜ªåºœ", "å…µåº«çœŒ",
            "å¥ˆè‰¯çœŒ", "å’Œæ­Œå±±çœŒ", "é³¥å–çœŒ", "å³¶æ ¹çœŒ", "å²¡å±±çœŒ", "åºƒå³¶çœŒ", "å±±å£çœŒ",
            "å¾³å³¶çœŒ", "é¦™å·çœŒ", "æ„›åª›çœŒ", "é«˜çŸ¥çœŒ", "ç¦å²¡çœŒ", "ä½è³€çœŒ", "é•·å´çœŒ",
            "ç†Šæœ¬çœŒ", "å¤§åˆ†çœŒ", "å®®å´çœŒ", "é¹¿å…å³¶çœŒ", "æ²–ç¸„çœŒ"
        ];

        // --- 4. æ ¸å¿ƒåŠŸèƒ½ï¼šå¾æ–‡å­—ä¸­æå–åœ°å (å¤§å¹…å¢å¼·ç‰ˆ) ---
        function extractLocationName(text) {
            if (!text) return null;
            
            // ç§»é™¤ HTML æ¨™ç±¤
            let cleanText = text.replace(/<[^>]*>/g, '');
            
            // ç­–ç•¥ 1: å°‹æ‰¾æ˜ç¢ºçš„ "ç¸£+å¸‚/å€/ç”º/æ‘" (ä¾‹å¦‚: åŒ—æµ·é“å°æ¨½å¸‚, å²©æ‰‹çœŒç››å²¡å¸‚)
            // Regex è§£é‡‹: (ç¸£å)(ä»»æ„1-6å­—)(å¸‚|å€|ç”º|æ‘)
            const regexFull = new RegExp(`(${PREFECTURES.join('|').replace(/çœŒ|åºœ|éƒ½/g, '')}[éƒ½é“åºœçœŒ]?)(.{1,6}(?:å¸‚|åŒº|ç”º|æ‘))`, 'g');
            const matchFull = regexFull.exec(cleanText);
            if (matchFull) {
                return matchFull[0]; // è¿”å›å®Œæ•´åŒ¹é…ï¼Œå¦‚ "åŒ—æµ·é“å°æ¨½å¸‚"
            }

            // ç­–ç•¥ 2: å°‹æ‰¾å–®ç¨çš„ "å¸‚/å€/ç”º/æ‘" (ä¾‹å¦‚: ç››å²¡å¸‚, ä¸Šå¸‚ç”º)
            // æ’é™¤å¸¸è¦‹èª¤åˆ¤è©å½™ (å¦‚: ãƒ‹ãƒ¥ãƒ¼ã‚¹, è­¦å¯Ÿç½², å¯¾ç­–å®¤)
            // Regex è§£é‡‹: ä»»æ„2-5å€‹æ¼¢å­—/ç‰‡å‡å + (å¸‚|å€|ç”º|æ‘)
            const regexCity = /([\u4e00-\u9fa5]{2,5}(?:å¸‚|åŒº|ç”º|æ‘))/g;
            let matchCity;
            while ((matchCity = regexCity.exec(cleanText)) !== null) {
                const candidate = matchCity[0];
                // éæ¿¾é»‘åå–®
                if (!candidate.includes("ãƒ‹ãƒ¥ãƒ¼ã‚¹") && !candidate.includes("è­¦å¯Ÿ") && !candidate.includes("ç›®æ’ƒ")) {
                    return candidate; // è¿”å› "ç››å²¡å¸‚"
                }
            }

            // ç­–ç•¥ 3: å°‹æ‰¾å–®ç¨çš„ç¸£å (ä¾‹å¦‚: åŒ—æµ·é“, ç§‹ç”°)
            for (let pref of PREFECTURES) {
                // æª¢æŸ¥å®Œæ•´ç¸£å æˆ– å»æ‰å¾Œç¶´çš„ç¸£å (ä¾‹å¦‚ "ç§‹ç”°çœŒ" æˆ– "ç§‹ç”°")
                const shortName = pref.replace(/[éƒ½é“åºœçœŒ]$/, '');
                if (cleanText.includes(pref)) return pref;
                if (cleanText.includes(shortName)) return pref; // è£œå…¨ç‚ºå®Œæ•´ç¸£å
            }

            return null; // çœŸçš„æ‰¾ä¸åˆ°äº†
        }

        // --- 5. è™•ç†éšŠåˆ— (API è«‹æ±‚) ---
        async function processQueue() {
            if (fetchQueue.length === 0) {
                document.getElementById('progress-text').innerText = "æ‰€æœ‰æ•¸æ“šè™•ç†å®Œç•¢";
                // å„²å­˜ç·©å­˜
                localStorage.setItem(CACHE_KEY, JSON.stringify(locationCache));
                return;
            }

            isProcessing = true;
            const task = fetchQueue.shift();
            const { item, locationName, itemId } = task;

            document.getElementById('progress-text').innerHTML = `<div class="loading-spinner"></div>æ­£åœ¨è§£æ: ${locationName}`;

            try {
                // å‘¼å« Nominatim API (OpenStreetMap)
                // åŠ ä¸Š countrycodes=jp é™åˆ¶åœ¨æ—¥æœ¬ï¼Œä¸¦åŠ ä¸Š limit=1
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locationName)}&countrycodes=jp&limit=1`;
                
                const response = await fetch(url, { headers: { 'User-Agent': 'BearMapApp/1.0' } });
                const data = await response.json();

                if (data && data.length > 0) {
                    const lat = data[0].lat;
                    const lon = data[0].lon;
                    
                    // å­˜å…¥ç·©å­˜
                    locationCache[locationName] = { lat: lat, lng: lon };
                    
                    // æ›´æ–°åœ°åœ–èˆ‡å¡ç‰‡
                    addToMap(item, lat, lon, false);
                    updateCardStatus(itemId, "success", locationName);
                } else {
                    updateCardStatus(itemId, "fail", locationName);
                    console.warn(`API æ‰¾ä¸åˆ°åœ°é»: ${locationName}`);
                }

            } catch (error) {
                console.error("API Error:", error);
                updateCardStatus(itemId, "fail", locationName);
            }

            // ç¦®è²Œæ€§å»¶é² (é¿å…è¢« API å°é–) - 1.2ç§’
            setTimeout(processQueue, 1200);
        }

        // --- 6. UI æ›´æ–°å‡½æ•¸ ---
        function updateCardStatus(itemId, status, locName) {
            const card = document.getElementById(itemId);
            if (!card) return;

            const badge = card.querySelector('.status-badge');
            const locSpan = card.querySelector('.loc-span');

            card.classList.remove('loc-success', 'loc-fail', 'loc-approx');
            badge.classList.remove('badge-success', 'badge-fail', 'badge-approx');

            if (status === 'success') {
                card.classList.add('loc-success');
                badge.classList.add('badge-success');
                badge.innerText = "â— å·²å®šä½";
                locSpan.innerText = locName;
            } else if (status === 'cached') {
                card.classList.add('loc-success');
                badge.classList.add('badge-success');
                badge.innerText = "â— ç·©å­˜";
                locSpan.innerText = locName;
            } else {
                card.classList.add('loc-fail');
                badge.classList.add('badge-fail');
                badge.innerText = "â— æ‰¾ä¸åˆ°åœ°é»";
                locSpan.innerText = locName || "æœªçŸ¥";
            }
        }

        function addToMap(item, lat, lng, isCached) {
            const marker = L.marker([lat, lng]);
            const popupContent = `
                <b>${item.title}</b><br>
                <span style="font-size:0.8rem; color:#666;">${item.date}</span><br>
                <a href="${item.link}" target="_blank">æŸ¥çœ‹æ–°è</a>
            `;
            marker.bindPopup(popupContent);
            markers.addLayer(marker);
        }

        function createNewsCard(item, index) {
            const itemId = `news-${index}`;
            
            // å˜—è©¦æå–åœ°å
            // å„ªå…ˆæª¢æŸ¥æ¨™é¡Œï¼Œå…¶æ¬¡æª¢æŸ¥æè¿°(å¦‚æœæœ‰)
            let rawText = item.title + " " + (item.description || "");
            let locationName = extractLocationName(rawText);

            const div = document.createElement('div');
            div.className = 'news-card';
            div.id = itemId;
            div.innerHTML = `
                <div class="news-title">
                    ${item.title}
                    <span class="status-badge badge-approx">ç­‰å¾…è§£æ</span>
                </div>
                <div class="news-meta">
                    æ—¥æœŸ: ${item.date} | åœ°é»åˆ¤å®š: <span class="loc-span">${locationName || "æœªçŸ¥"}</span>
                </div>
                <a href="${item.link}" class="news-link" target="_blank">é–±è®€æ–°è (${item.source || "Source"})</a>
            `;
            
            // é»æ“Šå¡ç‰‡ç§»å‹•åœ°åœ– (å¦‚æœå·²å®šä½)
            div.addEventListener('click', (e) => {
                if(e.target.tagName === 'A') return; // é»æ“Šé€£çµä¸è§¸ç™¼
                if (locationName && locationCache[locationName]) {
                    const loc = locationCache[locationName];
                    map.flyTo([loc.lat, loc.lng], 12);
                }
            });

            document.getElementById('news-list').appendChild(div);

            return { itemId, locationName };
        }

        // --- 7. ä¸»æµç¨‹ ---
        fetch('bear_data.json')
            .then(response => {
                if (!response.ok) throw new Error("HTTP error " + response.status);
                return response.json();
            })
            .then(data => {
                document.getElementById('progress-text').innerText = `è®€å–åˆ° ${data.length} ç­†æ•¸æ“šï¼Œé–‹å§‹è§£æ...`;
                
                data.forEach((item, index) => {
                    const { itemId, locationName } = createNewsCard(item, index);

                    if (locationName) {
                        if (locationCache[locationName]) {
                            // å‘½ä¸­ç·©å­˜
                            addToMap(item, locationCache[locationName].lat, locationCache[locationName].lng, true);
                            updateCardStatus(itemId, "cached", locationName);
                        } else {
                            // åŠ å…¥å¾…æŠ“å–éšŠåˆ—
                            fetchQueue.push({ item, locationName, itemId });
                        }
                    } else {
                        updateCardStatus(itemId, "fail", null);
                    }
                });

                // å•Ÿå‹•éšŠåˆ—è™•ç†
                if (fetchQueue.length > 0) {
                    processQueue();
                } else {
                    document.getElementById('progress-text').innerText = "å…¨éƒ¨ç”±ç·©å­˜è¼‰å…¥å®Œæˆ";
                }
            })
            .catch(err => {
                console.error("è®€å– JSON å¤±æ•—:", err);
                document.getElementById('news-list').innerHTML = `<div style="padding:20px; color:#ff4444;">è®€å– bear_data.json å¤±æ•—ã€‚<br>è«‹ç¢ºèªæª”æ¡ˆå­˜åœ¨ä¸”ç‚ºç´” JSON æ ¼å¼ã€‚<br>éŒ¯èª¤: ${err.message}</div>`;
            });

        function clearCache() {
            localStorage.removeItem(CACHE_KEY);
            location.reload();
        }

    </script>
</body>
</html>
