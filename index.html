<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨æ—¥æœ¬ç†Šå‡ºæ²’åœ°åœ– (å³æ™‚æ•¸æ“šç‰ˆ)</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

    <style>
        body { margin: 0; display: flex; height: 100vh; font-family: "Microsoft JhengHei", sans-serif; background: #1a1a1a; color: #e0e0e0; }
        #map { flex: 3; height: 100%; z-index: 1; }
        #sidebar { flex: 1; padding: 20px; overflow-y: auto; background: #222; box-shadow: -2px 0 10px rgba(0,0,0,0.5); z-index: 2; }
        
        /* Header */
        .header { margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .header h2 { margin: 0; color: #fff; display: flex; align-items: center; gap: 10px; }
        .status-bar { font-size: 0.85em; color: #aaa; margin-top: 8px; display: flex; justify-content: space-between; }
        
        /* Card Design */
        .card { 
            background: #333; 
            margin-bottom: 15px; 
            padding: 15px; 
            border-radius: 6px; 
            border-left: 5px solid #555; 
            transition: all 0.3s ease;
            position: relative;
        }
        .card.locating { border-left-color: #ffcc00; } /* æœå°‹ä¸­ - é»ƒè‰² */
        .card.located { border-left-color: #00cc66; }  /* å·²å®šä½ - ç¶ è‰² */
        .card.failed { border-left-color: #ff4444; }   /* å¤±æ•— - ç´…è‰² */

        .card h3 { margin: 0 0 8px 0; font-size: 1rem; line-height: 1.4; color: #fff; }
        .card .meta { font-size: 0.8em; color: #bbb; margin-bottom: 5px; }
        .card .status-text { font-size: 0.75em; font-weight: bold; float: right; }
        .status-searching { color: #ffcc00; }
        .status-success { color: #00cc66; }
        .status-error { color: #ff4444; }

        .card a { color: #66b3ff; text-decoration: none; font-size: 0.9em; display: inline-block; margin-top: 5px; }
        .card a:hover { text-decoration: underline; }

        /* Cluster Color Override */
        .marker-cluster-small, .marker-cluster-medium, .marker-cluster-large {
            background-color: rgba(255, 100, 100, 0.6) !important;
        }
        .marker-cluster div {
            background-color: rgba(200, 0, 0, 0.8) !important;
            color: white;
        }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            #map { flex: 2; }
            #sidebar { flex: 1; }
        }
    </style>
</head>
<body>

<div id="map"></div>
<div id="sidebar">
    <div class="header">
        <h2>ğŸ» æ™ºèƒ½ç†Šå‡ºæ²’ç›£æ¸¬</h2>
        <div class="status-bar">
            <span id="progress-text">è®€å–æ•¸æ“šä¸­...</span>
            <button onclick="clearCache()" style="background:none; border:none; color:#666; cursor:pointer; font-size:0.8em; text-decoration:underline;">æ¸…é™¤ç·©å­˜</button>
        </div>
    </div>
    <div id="news-list"></div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
    // --- 1. åˆå§‹åŒ–åœ°åœ– ---
    const map = L.map('map').setView([38.0, 138.0], 5);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: 'Â© OpenStreetMap, Â© CARTO'
    }).addTo(map);

    const markers = L.markerClusterGroup({
        maxClusterRadius: 40,
        spiderfyOnMaxZoom: true
    });
    map.addLayer(markers);

    const bearIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
        shadowSize: [41, 41]
    });

    // --- 2. æ ¸å¿ƒé‚è¼¯ï¼šRegex + Cache + API ---

    // ç·©å­˜ç³»çµ±
    const CACHE_KEY = 'bear_map_cache_v2'; // å‡ç´š key ç‰ˆæœ¬
    let locationCache = JSON.parse(localStorage.getItem(CACHE_KEY)) || {};

    function saveCache() {
        localStorage.setItem(CACHE_KEY, JSON.stringify(locationCache));
    }
    
    window.clearCache = function() {
        localStorage.removeItem(CACHE_KEY);
        alert('ç·©å­˜å·²æ¸…é™¤ï¼Œè«‹åˆ·æ–°é é¢é‡æ–°æŠ“å–ã€‚');
        location.reload();
    }

    // Regex æå–åœ°å
    function extractLocation(title) {
        // ç­–ç•¥ 1: æ‹¬è™Ÿå…§çš„å…§å®¹ (é€šå¸¸æ˜¯ç¸£å¸‚)
        const parenMatch = title.match(/ï¼ˆ(.*?)ï¼‰/);
        let region = "";
        if (parenMatch) {
            region = parenMatch[1];
        }

        // ç­–ç•¥ 2: æŠ“å– "XXçœŒXXå¸‚" æˆ– "XXå¸‚XXç”º"
        const geoRegex = /(åŒ—æµ·é“|é’æ£®|å²©æ‰‹|å®®åŸ|ç§‹ç”°|å±±å½¢|ç¦å³¶|èŒ¨åŸ|æ ƒæœ¨|ç¾¤é¦¬|åŸ¼ç‰|åƒè‘‰|æ±äº¬|ç¥å¥ˆå·|æ–°æ½Ÿ|å¯Œå±±|çŸ³å·|ç¦äº•|å±±æ¢¨|é•·é‡|å²é˜œ|é™å²¡|æ„›çŸ¥|ä¸‰é‡|æ»‹è³€|äº¬éƒ½|å¤§é˜ª|å…µåº«|å¥ˆè‰¯|å’Œæ­Œå±±|é³¥å–|å³¶æ ¹|å²¡å±±|åºƒå³¶|å±±å£|å¾³å³¶|é¦™å·|æ„›åª›|é«˜çŸ¥|ç¦å²¡|ä½è³€|é•·å´|ç†Šæœ¬|å¤§åˆ†|å®®å´|é¹¿å…å³¶|æ²–ç¸„)[çœŒåºœéƒ½é“]?.*?([å¸‚ç”ºæ‘åŒº])/;
        
        const match = title.match(geoRegex);
        
        if (match) {
            return match[0];
        } else if (region) {
            const cityMatch = title.match(/.*?([å¸‚ç”ºæ‘åŒº])/);
            if (cityMatch) {
                return region + cityMatch[1]; 
            }
            return region;
        }
        
        // ç­–ç•¥ 3: å°‹æ‰¾å¸¸è¦‹åœ°åå¾Œç¶´ (æ’é™¤é›œè¨Š)
        const looseMatch = title.match(/.*?([å¸‚ç”ºæ‘])/);
        if (looseMatch && !title.includes("æ—¥æœ¬ä¸å¯©è€…")) {
            return looseMatch[0];
        }

        return null;
    }

    // éšŠåˆ—ç³»çµ± (Rate Limiting)
    let fetchQueue = [];
    let isProcessing = false;

    function addToMap(item, lat, lng, isCached) {
        // å¢åŠ éš¨æ©Ÿåç§»ï¼Œé˜²æ­¢åŒä¸€åŸå¸‚çš„é»å®Œå…¨é‡ç–Š
        const jitter = 0.005; 
        const finalLat = parseFloat(lat) + (Math.random() - 0.5) * jitter;
        const finalLng = parseFloat(lng) + (Math.random() - 0.5) * jitter;

        // ç¢ºä¿ ID å­˜åœ¨ï¼Œå¦‚æœ JSON æ²’æœ‰ IDï¼Œç”¨æ¨™é¡Œçš„ Hash ä»£æ›¿
        const itemId = item.id || 'id-' + Math.abs(item.title.split("").reduce((a,b)=>{a=((a<<5)-a)+b.charCodeAt(0);return a&a},0));

        const marker = L.marker([finalLat, finalLng], {icon: bearIcon})
            .bindPopup(`<b>${item.title}</b><br><small>${item.date}</small><br><a href="${item.link}" target="_blank">ä¾†æº: ${item.source}</a>`);
        markers.addLayer(marker);

        // æ›´æ–°å´é‚Šæ¬„ç‹€æ…‹
        const card = document.getElementById(`card-${itemId}`);
        if (card) {
            card.classList.remove('locating');
            card.classList.add('located');
            const statusSpan = card.querySelector('.status-text');
            statusSpan.innerHTML = isCached ? 'âš¡ ç·©å­˜å‘½ä¸­' : 'ğŸŸ¢ API å®šä½';
            statusSpan.className = 'status-text status-success';
        }
    }

    function processQueue() {
        if (fetchQueue.length === 0) {
            isProcessing = false;
            document.getElementById('progress-text').innerText = "æ‰€æœ‰æ•¸æ“šè™•ç†å®Œç•¢";
            return;
        }

        isProcessing = true;
        const task = fetchQueue.shift();
        const { item, locationName, itemId } = task;

        document.getElementById('progress-text').innerText = `æ­£åœ¨å®šä½: ${locationName}... (å‰©é¤˜ ${fetchQueue.length})`;

        // OpenStreetMap Nominatim API
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locationName)}`)
            .then(res => res.json())
            .then(data => {
                if (data && data.length > 0) {
                    const lat = data[0].lat;
                    const lon = data[0].lon;
                    
                    // å­˜å…¥ç·©å­˜
                    locationCache[locationName] = { lat: lat, lng: lon };
                    saveCache();

                    addToMap(item, lat, lon, false);
                } else {
                    // å¤±æ•—è™•ç†
                    const card = document.getElementById(`card-${itemId}`);
                    if(card) {
                        card.classList.remove('locating');
                        card.classList.add('failed');
                        card.querySelector('.status-text').innerText = 'ğŸ”´ æ‰¾ä¸åˆ°åœ°é»';
                        card.querySelector('.status-text').className = 'status-text status-error';
                    }
                }
            })
            .catch(err => console.error(err))
            .finally(() => {
                // åš´æ ¼éµå®ˆ API è¦ç¯„ï¼Œé–“éš” 1.2 ç§’
                setTimeout(processQueue, 1200);
            });
    }

    // --- 3. ä¸»ç¨‹å¼ï¼šè®€å–å¤–éƒ¨ JSON ---
    
    // ä½¿ç”¨æ™‚é–“æˆ³é˜²æ­¢ç€è¦½å™¨ç·©å­˜ JSON æª”æ¡ˆ
    fetch('bear_data.json?t=' + new Date().getTime())
        .then(response => {
            if (!response.ok) {
                throw new Error("HTTP error " + response.status);
            }
            return response.json();
        })
        .then(data => {
            const list = document.getElementById('news-list');
            document.getElementById('progress-text').innerText = `è®€å–åˆ° ${data.length} ç­†è³‡æ–™ï¼Œé–‹å§‹åˆ†æ...`;

            data.forEach((item, index) => {
                // ç”¢ç”Ÿå”¯ä¸€ ID (å¦‚æœ JSON è£¡æ²’æœ‰ id æ¬„ä½)
                const itemId = item.id || 'id-' + index;
                item.id = itemId; // è£œå› item ç‰©ä»¶æ–¹ä¾¿å¾ŒçºŒä½¿ç”¨

                // 1. å»ºç«‹å´é‚Šæ¬„å¡ç‰‡
                const card = document.createElement('div');
                card.className = 'card locating'; 
                card.id = `card-${itemId}`;
                
                // å˜—è©¦æå–åœ°å
                let locName = extractLocation(item.title);
                
                let displayTitle = item.title.length > 40 ? item.title.substring(0, 40) + "..." : item.title;

                card.innerHTML = `
                    <span class="status-text status-searching">ğŸŸ¡ æœå°‹ä¸­...</span>
                    <h3>${displayTitle}</h3>
                    <div class="meta">æ—¥æœŸ: ${item.date} | åœ°é»åˆ¤å®š: ${locName || "æœªçŸ¥"}</div>
                    <a href="${item.link}" target="_blank">é–±è®€æ–°è (${item.source})</a>
                `;
                list.appendChild(card);

                if (!locName) {
                    card.classList.remove('locating');
                    card.classList.add('failed');
                    card.querySelector('.status-text').innerText = "ğŸ”´ ç„¡æ³•è§£æåœ°å";
                    card.querySelector('.status-text').className = 'status-text status-error';
                    return;
                }

                // 2. æª¢æŸ¥ç·©å­˜
                if (locationCache[locName]) {
                    // å‘½ä¸­ç·©å­˜ -> ç«‹å³é¡¯ç¤º
                    addToMap(item, locationCache[locName].lat, locationCache[locName].lng, true);
                } else {
                    // æœªå‘½ä¸­ -> åŠ å…¥ API éšŠåˆ—
                    fetchQueue.push({ item: item, locationName: locName, itemId: itemId });
                }
            });

            // å•Ÿå‹•éšŠåˆ—
            if (fetchQueue.length > 0) {
                processQueue();
            } else {
                document.getElementById('progress-text').innerText = "å…¨éƒ¨ç”±ç·©å­˜è¼‰å…¥å®Œæˆ";
            }
        })
        .catch(err => {
            console.error("è®€å– JSON å¤±æ•—:", err);
            document.getElementById('news-list').innerHTML = `<div style="padding:20px; color:#ff4444;">è®€å– bear_data.json å¤±æ•—ã€‚<br>è«‹ç¢ºä¿æª”æ¡ˆå­˜åœ¨ä¸”æ ¼å¼æ­£ç¢ºã€‚<br>éŒ¯èª¤è¨Šæ¯: ${err.message}</div>`;
        });

</script>

</body>
</html>
