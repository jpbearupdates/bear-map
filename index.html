<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨æ—¥æœ¬ç†Šå‡ºæ²’åœ°åœ– (è‡ªå‹•å®šä½ç‰ˆ)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

    <style>
        body { margin: 0; display: flex; height: 100vh; font-family: "Microsoft JhengHei", sans-serif; background: #1a1a1a; color: #e0e0e0; }
        #map { flex: 3; height: 100%; }
        #sidebar { flex: 1; padding: 20px; overflow-y: auto; background: #2d2d2d; box-shadow: -2px 0 10px rgba(0,0,0,0.5); }
        
        .card { background: #3d3d3d; margin-bottom: 15px; padding: 15px; border-radius: 8px; border-left: 5px solid #888; transition: all 0.3s; }
        .card.located { border-left-color: #44ff44; } /* æˆåŠŸå®šä½è®Šç¶ è‰² */
        .card.searching { border-left-color: #ffff44; } /* æœå°‹ä¸­è®Šé»ƒè‰² */
        
        .card h4 { margin: 0 0 5px 0; color: #fff; font-size: 1.1em; }
        .card .meta { font-size: 0.85em; color: #aaa; margin-bottom: 8px; }
        .status-tag { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.75em; margin-top: 5px; background: #444; color: #ccc;}
        
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid #3498db; border-radius: 50%; width: 12px; height: 12px; animation: spin 1s linear infinite; display: inline-block; margin-right: 5px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            #map { flex: 2; }
            #sidebar { flex: 1; }
        }
    </style>
</head>
<body>

<div id="map"></div>
<div id="sidebar">
    <h2 style="color: #ff4444;">ğŸ‡¯ğŸ‡µ å…¨æ—¥æœ¬ç†Šå‡ºæ²’æƒ…å ±</h2>
    <p style="font-size: 0.9em; color: #aaa;">ç³»çµ±æœƒè‡ªå‹•åˆ†æåœ°åä¸¦æœå°‹åº§æ¨™ã€‚<br>ç¬¬ä¸€æ¬¡è¼‰å…¥å¯èƒ½éœ€è¦å°‘å°‘æ™‚é–“ã€‚</p>
    <div id="status-bar" style="margin-bottom: 10px; font-size: 0.8em; color: #44ff44;"></div>
    <div id="news-list"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
    // 1. åˆå§‹åŒ–åœ°åœ–ï¼šè¦–è§’è¨­åœ¨æ—¥æœ¬ä¸­å¿ƒ
    const map = L.map('map').setView([36.2048, 138.2529], 5); 
    
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: 'Â© OpenStreetMap, Â© CARTO'
    }).addTo(map);

    const markers = L.markerClusterGroup();
    map.addLayer(markers);

    const bearIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
        shadowSize: [41, 41]
    });

    // 2. æ¨¡æ“¬å…¨æ—¥æœ¬å„åœ°çš„äº‚æ•¸æ“š (å…¨éƒ¨æ•…æ„ç„¡åº§æ¨™ï¼Œæˆ–è€…åº§æ¨™éŒ¯èª¤)
    const mockData = [
        { location: "åŒ—æµ·é“æœ­å¹Œå¸‚å—åŒºã§ãƒ’ã‚°ãƒç›®æ’ƒ", title: "ä½å®…è¡—ä»˜è¿‘", date: "2025-11-20", source: "NHK" },
        { location: "ç§‹ç”°çœŒå¤§ä»™å¸‚å¤§æ›²ã§ã‚¯ãƒå‡ºæ²¡", title: "æ²³å·æ•·", date: "2025-11-19", source: "Police" },
        { location: "æ±äº¬éƒ½å…«ç‹å­å¸‚é«˜å°¾å±±ä»˜è¿‘", title: "ç™»å±±é“", date: "2025-11-18", source: "Twitter" },
        { location: "é•·é‡çœŒè»½äº•æ²¢ç”ºã§ã‚¯ãƒ", title: "åˆ¥è˜åœ°", date: "2025-11-18", source: "News" },
        { location: "äº¬éƒ½åºœäº¬éƒ½å¸‚å·¦äº¬åŒº", title: "å±±é–“éƒ¨", date: "2025-11-17", source: "Local" },
        { location: "ç†Šæœ¬çœŒç†Šæœ¬å¸‚è¥¿åŒº", title: "ã¿ã‹ã‚“ç•‘", date: "2025-11-16", source: "Police" },
        { location: "å²©æ‰‹çœŒç››å²¡å¸‚", title: "å¸‚è¡—åœ°ç¸è¾º", date: "2025-11-19", source: "NHK" }
    ];

    // 3. æœ¬åœ°ç·©å­˜ (LocalStorage) - é¿å…é‡è¤‡ Call API
    // æ ¼å¼: { "åŒ—æµ·é“æœ­å¹Œå¸‚": {lat: 43.06, lng: 141.35}, ... }
    const GEO_CACHE_KEY = 'bear_map_cache_v1';
    let geoCache = JSON.parse(localStorage.getItem(GEO_CACHE_KEY)) || {};

    function saveCache() {
        localStorage.setItem(GEO_CACHE_KEY, JSON.stringify(geoCache));
    }

    // 4. å¾å­—ä¸²æå–åœ°å (Regex)
    // å˜—è©¦æå– "XXçœŒXXå¸‚" æˆ– "XXéƒ½XXåŒº" æˆ– "XXå¸‚"
    function extractPlaceName(text) {
        // ç°¡å–®çš„æ­£å‰‡è¡¨é”å¼ï¼ŒåŒ¹é…å¸¸è¦‹æ—¥æœ¬åœ°åæ ¼å¼
        // å„ªå…ˆåŒ¹é…ï¼šç¸£/éƒ½/åºœ/é“ + å¸‚/å€/ç”º/æ‘
        const regex = /([ä¸€-é¾ ]+[éƒ½é“åºœçœŒ])?([ä¸€-é¾ ]+[å¸‚åŒºç”ºæ‘])/;
        const match = text.match(regex);
        
        if (match) {
            // å¦‚æœæœ‰ç¸£å+å¸‚å (e.g. ç§‹ç”°çœŒå¤§ä»™å¸‚) -> è¿”å›å…¨å
            // å¦‚æœåªæœ‰å¸‚å (e.g. å¤§ä»™å¸‚) -> è¿”å›å¸‚å
            return match[0]; 
        }
        return null;
    }

    // 5. æŸ¥è©¢åº§æ¨™å‡½æ•¸ (ä½¿ç”¨ OpenStreetMap Nominatim API)
    async function fetchCoordinates(query) {
        if (!query) return null;

        // æª¢æŸ¥ç·©å­˜
        if (geoCache[query]) {
            console.log(`[Cache Hit] ${query}`);
            return geoCache[query];
        }

        // å‘¼å« API (åŠ å»¶é²é¿å…è¢« Ban)
        await new Promise(r => setTimeout(r, 1200)); // 1.2ç§’å»¶é²
        
        try {
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;
            const response = await fetch(url, { headers: { "User-Agent": "BearMapDemo/1.0" } });
            const data = await response.json();

            if (data && data.length > 0) {
                const coords = { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
                // å¯«å…¥ç·©å­˜
                geoCache[query] = coords;
                saveCache();
                return coords;
            }
        } catch (e) {
            console.error("API Error:", e);
        }
        return null;
    }

    // 6. ä¸»è™•ç†æµç¨‹
    async function processAllData(data) {
        const list = document.getElementById('news-list');
        const statusBar = document.getElementById('status-bar');
        
        for (let i = 0; i < data.length; i++) {
            const item = data[i];
            const placeName = extractPlaceName(item.location);
            
            // å»ºç«‹å¡ç‰‡ UI (åˆå§‹ç‹€æ…‹)
            const cardId = `card-${i}`;
            const card = document.createElement('div');
            card.id = cardId;
            card.className = 'card searching';
            card.innerHTML = `
                <h4>${item.location}</h4>
                <div class="meta">${item.date} | ${item.source}</div>
                <div class="status-tag" id="status-${i}">
                    <div class="loader"></div> æ­£åœ¨æœå°‹åº§æ¨™: ${placeName || "æœªçŸ¥"}...
                </div>
            `;
            list.appendChild(card);

            if (placeName) {
                statusBar.innerText = `æ­£åœ¨è™•ç†: ${placeName} (${i+1}/${data.length})`;
                
                // åŸ·è¡Œæœå°‹
                const coords = await fetchCoordinates(placeName);
                
                const statusTag = document.getElementById(`status-${i}`);
                const cardDiv = document.getElementById(cardId);

                if (coords) {
                    // éš¨æ©Ÿåç§» (Jitter)
                    const jitter = 0.03;
                    const finalLat = coords.lat + (Math.random() - 0.5) * jitter;
                    const finalLng = coords.lng + (Math.random() - 0.5) * jitter;

                    // æ›´æ–°åœ°åœ–
                    const marker = L.marker([finalLat, finalLng], {icon: bearIcon})
                        .bindPopup(`<h3>${item.location}</h3><p>${item.title}</p>`);
                    markers.addLayer(marker);
                    
                    // æ›´æ–° UI
                    cardDiv.classList.remove('searching');
                    cardDiv.classList.add('located');
                    statusTag.innerHTML = `ğŸ“ å·²å®šä½ (${placeName})`;
                    statusTag.style.background = "#225522";
                    statusTag.style.color = "#88ff88";
                    
                    // é»æ“Šå¡ç‰‡é£›å»åœ°åœ–
                    cardDiv.onclick = () => {
                        map.setView([finalLat, finalLng], 12);
                        marker.openPopup();
                    };

                } else {
                    statusTag.innerHTML = `âš ï¸ ç„¡æ³•å®šä½`;
                    statusTag.style.background = "#552222";
                }
            } else {
                document.getElementById(`status-${i}`).innerHTML = `âŒ ç„¡æ³•è­˜åˆ¥åœ°å`;
            }
        }
        statusBar.innerText = "æ‰€æœ‰æ•¸æ“šè™•ç†å®Œç•¢ã€‚";
    }

    // é–‹å§‹åŸ·è¡Œ
    processAllData(mockData);

</script>

</body>
</html>
